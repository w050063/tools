# 直播相关内容

## 视频直播概述
### 视频直播发展阶段
视频直播发展经历了四个历史阶段，分别是：模拟电视、数字电视、IPTV和OTT、移动直播
视频直播按照内容分类为：社交、游戏、在线教育与医疗等移动视频直播类型
兴起原因：
- 网络的发展，带宽扩容、提速，为移动视频直播领域发展奠定了基础
- 硬件设备的发展，PC端：YY,六间房、呱呱等直播应用，智能移动端：映客、花椒、小米直播
- 多元化生活

### 视频直播发展瓶颈
- 内容违规：影响平台的美誉度
- 卡顿：严重影响用户的体验

### 优化及防护手段
直播平台播放的流畅性主要受四方面因素影响，分别是推流端、视频源、CDN、播放端，其中播放端是直播卡顿的直接表现环节，但减少和消除卡顿，需要从全链路多环节着手。

推流端
- 网络抖动后快速调整编码码率
- 实时监测预测网络质量
- 尽可能保持编码码率和网络速率吻合
- 稳步提升至高位码率

视频源站
- 实时监控直播平台服务器网络状况
- 推流卡顿分析
视频直播具有强时间关联性，每一帧数据都有自己的编码时间戳和播放时间戳，通过编码时间戳可以计算推流的理论码率，在接收时对每帧数据进行打点，可以计算出推流实际码率，对二者进行比较，则可以在源站对推流的卡顿进行统计。

CDN分发节点卡顿分析
在智能调度CDN分发节点，通过对下行分发缓冲区的大小监控，来实时感知下行分发的卡顿情况。



live直播

流媒体服务器
rtmp和http-flv

网络视频直播存在已有很长一段时间，随着移动上下行带宽提升及资费的下调，视频直播被赋予了更多娱乐和社交的属性，人们享受随时随地进行直播和观看，主播不满足于单向的直播，观众则更渴望互动，直播的打开时间和延迟变成了影响产品功能发展重要指标。那么，问题来了： 如何实现低延迟、秒开的直播？
先来看看视频直播的5个关键的流程：录制->编码->网络传输->解码->播放，每个环节对于直播的延迟都会产生不同程度的影响。这里重点分析移动设备的情况。受限于技术的成熟度、硬件环境等，我们针对移动场景简单总结出直播延迟优化的4个点：网络、协议、编解码、移动终端

直播协议：RTMP、HLS、HDL（HTTP-FLV）、RTP
# RTMP协议：

是Adobe的专利协议，现在大部分国外的CDN已不支持。在国内流行度很高。原因有几个方面：

- 1、开源软件和开源库的支持稳定完整。如斗鱼主播常用的OBS软件，开源的librtmp库，服务端有nginx-rtmp插件。
- 2、播放端安装率高。只要浏览器支持FlashPlayer就能非常简易的播放RTMP的直播，协议详解可以Google了解。相对其他协议而言，RTMP协议初次建立连接的时候握手过程过于复杂（底层基于TCP，这里说的是RTMP协议本身的交互），视不同的网络状况会带来给首开带来100ms以上的延迟。基于RTMP的直播一般内容延迟在2~5秒。

# HTTP-FLV协议：

即使用HTTP协议流式的传输媒体内容。相对于RTMP，HTTP更简单和广为人知，而且不担心被Adobe的专利绑架。内容延迟同样可以做到2~5秒，打开速度更快，因为HTTP本身没有复杂的状态交互。所以从延迟角度来看，HTTP-FLV要优于RTMP。

# HLS 协议：

即Http Live Streaming，是由苹果提出基于HTTP的流媒体传输协议。HLS有一个非常大的优点：HTML5可以直接打开播放；这个意味着可以把一个直播链接通过微信等转发分享，不需要安装任何独立的APP，有浏览器即可，所以流行度很高。社交直播APP，HLS可以说是刚需

# RTP协议：

即Real-time Transport Protocol，用于Internet上针对多媒体数据流的一种传输层协议。

实际应用场景下经常需要RTCP（RTP Control Protocol）配合来使用，可以简单理解为RTCP传输交互控制的信令，RTP传输实际的媒体数据。

RTP在视频监控、视频会议、IP电话上有广泛的应用，因为视频会议、IP电话的一个重要的使用体验：内容实时性强。

对比与上述3种或实际是2种协议，RTP和它们有一个重要的区别就是默认是使用UDP协议来传输数据，而RTMP和HTTP是基于TCP协议传输。为什么UDP 能做到如此实时的效果呢？关于TCP和UDP差别的分析文章一搜一大把，这里不在赘述，简单概括：

UDP：单个数据报，不用建立连接，简单，不可靠，会丢包，会乱序；

TCP：流式，需要建立连接，复杂，可靠 ，有序。

实时音视频流的场景不需要可靠保障，因此也不需要有重传的机制，实时的看到图像声音，网络抖动时丢了一些内容，画面模糊和花屏，完全不重要。TCP为了重传会造成延迟与不同步，如某一截内容因为重传，导致1秒以后才到，那么整个对话就延迟了1秒，随着网络抖动，延迟还会增加成2秒、3秒，如果客户端播放是不加以处理将严重影响直播的体验。

总结一下：在直播协议的选择中，如果选择是RTMP或HTTP-FLV则意味着有2~5秒的内容延迟，但是就打开延迟开，HTTP-FLV 要优于RTMP。HLS则有5~7秒的内容延迟。选择RTP进行直播则可以做到1秒内的直播延迟。但就目前所了解，各大CDN厂商没有支持基于RTP直播的，所以目前国内主流还是RTMP或HTTP-FLV。


# yamdi
yamdi是Yet Another MetaData Injector for FLV 的缩写。用于flv文件加入metadata。
作者开发yamdi的原因是：
在一个项目中我要向很大的flv文件（超过 1GB）中增加metadata数据。其他知名的免费工具，比如flvmdi和flvtool2并不适合这个场景，因为它们都是将整个文件读入内存。因为 我不熟悉ruby（为了修改flvtool2），而且flvmdi也不是开源的，因此我参照flv规范实现了用c开发的metadata injector。yamdi使用更少的内存而且更快。
yamdi为flv文件增加了很多metadata信息，比如创建者、是否有关键帧、是否有视频、是否有音频，视频高度和宽度等等。而yamdi加入的meta数据中，最有效的要数关键帧。被注入了关键帧的flv可以实现像土豆网、优酷网等大型视频网站一样的“拖进度”，提前拖到缓冲还未加载到的位置开始播放。
FLV视频是绝大多数视频网站首选的视频类型，国内外著名的视频分享站YouTube、优酷、土豆、新浪博客、QIYI等等都是Flash播放器播放FLV/MP4视频。
FLV有两种发布方式
一、普通的HTTP方式：这种方式通常需要预先下载到本地才能播放，有缓冲，但下载后就不会占用服务器资源。
二、流媒体方式：无需下载，可以实时播放任意拖拽进度，用户体验好但很耗服务器资源。

# Nginx搭建Flv流媒体服务器简介
Nginx中的Flv Stream模块能实现Flv流媒体的功能,而且支持Flv视频进度条拖拽，另外Nignx还可以作为方向代理服务器代理后端基于Flash Media Server或者Red5的RTMP/RTMP流媒体服务器

准备安装包
- nginx-1.2.3.tar.gz      					        ：应用服务器主程序
- nginx_mod_h264_streaming-2.2.7.tar.gz     ：MP4流媒体支持模块。
- openssl-1.0.1c.tar.gz                		  ：openssl库
- pcre-7.9.tar.gz                        		：perl兼容的正则表达式库模块           
- zlib-1.2.3.tar.gz                    			：liunx下的JFFS文件系统制作工具
- yamdi-1.9.tar.gz                     			：为flv文件添加关键帧，才能实现拖动播放


for((;;)); do \
    ./objs/ffmpeg/bin/ffmpeg -re -i ./doc/source.200kbps.768x320.flv \
    -vcodec copy -acodec copy \
    -f flv -y rtmp://10.1.16.151/live/livestream; \
    sleep 1; \
done

FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。

yum install -y nasm-*
git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg
cd ffmpeg
./configure
make && make install
